<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-Web | Central Gateway 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com" rel="stylesheet">
    <style>
        :root { --neon: #0ea5e9; --bg: #050505; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: white; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        .hidden { display: none !important; }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanner { height: 2px; background: var(--neon); box-shadow: 0 0 15px var(--neon); animation: scan 3s infinite; }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center">

    <!-- ==========================================
         1. PORTAL DE AUTENTICACI√ìN (API /AUTH)
         ========================================== -->
    <div id="auth-gate" class="w-full max-w-md p-8 glass rounded-[2.5rem] shadow-2xl relative overflow-hidden">
        <div class="scanner absolute inset-x-0 opacity-20"></div>
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold tracking-tighter text-sky-500 italic mb-2">Smart-Web</h1>
            <p class="text-[10px] uppercase tracking-[0.5em] text-gray-500 font-bold italic">Node: smartdns.duckdns.org</p>
        </div>

        <div id="auth-form" class="space-y-4 relative z-10">
            <input type="text" id="user-id" placeholder="IDENTIFICADOR" class="w-full bg-black/50 border border-white/10 p-5 rounded-2xl outline-none focus:border-sky-500 transition-all text-sm tracking-widest uppercase">
            <input type="password" id="user-pass" placeholder="ACCESS_CODE" class="w-full bg-black/50 border border-white/10 p-5 rounded-2xl outline-none focus:border-sky-500 transition-all text-sm tracking-widest uppercase text-white">
            
            <div class="flex gap-4 pt-4">
                <button onclick="handleAuth('login')" class="flex-1 bg-sky-600 hover:bg-sky-500 py-5 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg transition-all active:scale-95">Login</button>
                <button onclick="handleAuth('register')" class="flex-1 border border-sky-600/30 hover:bg-sky-600/10 py-5 rounded-2xl font-bold text-xs uppercase tracking-widest transition-all">Sign Up</button>
            </div>
            
            <button onclick="showRecovery()" class="w-full text-[10px] text-gray-600 mt-6 uppercase hover:text-sky-400 transition-colors tracking-widest">¬øOlvidaste tu acceso?</button>
        </div>

        <div id="recovery-panel" class="hidden text-center py-6">
            <p class="text-sm text-gray-400 mb-8 leading-relaxed italic">
                Si olvidaste tus credenciales, contacta a soporte o env√≠a un reporte a:<br>
                <span class="text-sky-500 font-bold underline select-all">kn-foundation25@gmail.com</span>
            </p>
            <button onclick="location.reload()" class="bg-white/5 px-8 py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest border border-white/10 hover:bg-white/10 transition-all">Regresar</button>
        </div>
    </div>

    <!-- ==========================================
         2. SISTEMA SMART-TUBE (10,000% SERVER POWER)
         ========================================== -->
    <div id="smart-tube" class="hidden h-screen w-screen flex flex-col bg-[#050505]">
        <!-- Header -->
        <header class="h-20 border-b border-white/5 flex items-center justify-between px-10 bg-black/80 backdrop-blur-md">
            <div class="flex items-center gap-10">
                <span class="text-2xl font-black italic text-sky-500 tracking-tighter">SMART-TUBE</span>
            </div>
            
            <div class="flex items-center gap-6">
                <button onclick="document.getElementById('upload-input').click()" class="bg-white text-black px-8 py-3 rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-sky-400 hover:text-white transition-all shadow-lg">
                    + Sync Multimedia
                </button>
                <div id="user-badge" class="w-12 h-12 rounded-2xl bg-sky-500/20 border border-sky-500/50 flex items-center justify-center font-bold text-sky-400">U</div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar: Salas Din√°micas (DB_CHATS) -->
            <aside class="w-24 border-r border-white/5 flex flex-col items-center py-10 gap-8 bg-black">
                <div onclick="createNewRoom()" class="w-12 h-12 rounded-2xl border border-white/10 flex items-center justify-center cursor-pointer hover:border-sky-500 text-sky-500 text-2xl transition-all font-bold">+</div>
                <div id="side-room-list" class="flex flex-col gap-6 w-full items-center overflow-y-auto custom-scroll"></div>
            </aside>

            <!-- Feed de Videos (DB_VIDEOS + STREAM) -->
            <main class="flex-1 overflow-y-auto p-12 custom-scroll bg-[#080808]">
                <div id="video-wall" class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-10">
                    <!-- Los videos se cargan desde el servidor aqu√≠ -->
                </div>
            </main>

            <!-- Sistema de Chat Multi-Room (DB_CHATS) -->
            <aside class="w-[400px] border-l border-white/5 flex flex-col bg-[#020202]">
                <div class="p-8 border-b border-white/5">
                    <h3 class="text-[10px] font-black tracking-[0.3em] text-gray-500 mb-4 uppercase italic">Communications_Gateway</h3>
                    <select id="room-select" onchange="switchRoom(this.value)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-[10px] font-bold outline-none text-sky-400">
                        <option value="general">CHANNEL_GENERAL</option>
                    </select>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-8 space-y-6 custom-scroll"></div>
                <div class="p-8 border-t border-white/5">
                    <div class="relative">
                        <input type="text" id="chat-inp" placeholder="Enviar paquete de datos..." class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none text-xs text-white focus:border-sky-400 transition-all">
                        <button onclick="sendMsg()" class="absolute right-4 top-1/2 -translate-y-1/2 text-sky-500 font-bold uppercase">‚û§</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Upload Oculto -->
    <input type="file" id="upload-input" class="hidden" accept="video/*" onchange="handleUpload(this.files)">

    <script>
        /* CONFIGURACI√ìN HACIA TU SERVIDOR DUCKDNS */
        const DOMAIN = "https://smartdns.duckdns.org"; 
        const API = `${DOMAIN}/api`;
        const STREAM = `${DOMAIN}/stream`;
        
        let currentUser = "";
        let currentRoom = "general";
        let roomsFound = new Set(["general"]);

        // --- AUTH: CONEXI√ìN REAL A DB_USERS ---
        async function handleAuth(mode) {
            const username = document.getElementById('user-id').value;
            const password = document.getElementById('user-pass').value;
            if(!username || !password) return alert("Error: Faltan credenciales.");

            try {
                const res = await fetch(`${API}/auth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, mode})
                });
                const data = await res.json();
                if(data.status === "success") {
                    if(mode === "register") alert("USUARIO REGISTRADO EN EL SERVIDOR CENTRAL");
                    else { currentUser = username; launchApp(); }
                } else alert("GATEWAY ERROR: " + data.msg);
            } catch(e) { alert("ERROR DE RED: No se pudo conectar con " + DOMAIN); }
        }

        function showRecovery() {
            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('recovery-panel').classList.remove('hidden');
        }

        function launchApp() {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('smart-tube').classList.remove('hidden');
            document.getElementById('user-badge').innerText = currentUser.substring(0,2).toUpperCase();
            refreshVideos();
            refreshChats();
            setInterval(refreshChats, 3000); // Polling de chat cada 3 segundos
        }

        // --- VIDEOS: ACTIVANDO DB_VIDEOS, DB_LIKES Y STREAMING ---
        async function refreshVideos() {
            try {
                const res = await fetch(`${API}/videos`);
                const vids = await res.json();
                const wall = document.getElementById('video-wall');
                wall.innerHTML = "";
                vids.forEach(v => {
                    wall.innerHTML += `
                    <div class="glass rounded-[2rem] overflow-hidden group border border-white/5 hover:border-sky-500/50 transition-all duration-500">
                        <div class="aspect-video relative bg-black">
                            <img src="${STREAM}/thumb/${v.id}/${v.author}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" onerror="this.src='https://via.placeholder.com'">
                        </div>
                        <div class="p-8">
                            <h4 class="font-bold text-sm mb-2 line-clamp-2">${v.title}</h4>
                            <div class="flex items-center justify-between mt-6">
                                <span class="text-[10px] font-bold text-sky-500 uppercase tracking-widest">${v.author}</span>
                                <div class="flex gap-4">
                                    <button onclick="interactSocial('${v.id}')" class="flex gap-2 hover:scale-110 transition-transform">
                                        <span class="text-sky-500">üíô</span>
                                        <span id="lk-${v.id}" class="text-xs font-bold text-white">${v.likes}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
            } catch(e) { console.error("Error al sincronizar videos del servidor."); }
        }

        async function interactSocial(id) {
            try {
                const res = await fetch(`${API}/social/interact/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user: currentUser, like: true})
                });
                const data = await res.json();
                document.getElementById(`lk-${id}`).innerText = data.count;
            } catch(e) { console.error("Error en comunicaci√≥n social."); }
        }

        // --- MULTI-CHAT: LECTURA Y FILTRADO DE DB_CHATS ---
        async function refreshChats() {
            try {
                const res = await fetch(`${API}/chats`);
                const chats = await res.json();
                
                // Actualizar lista de salas conocidas en base a los datos reales
                chats.forEach(c => { if(c.room) roomsFound.add(c.room); });
                syncRoomUI();

                const box = document.getElementById('chat-messages');
                const filtered = chats.filter(c => (c.room || "general") === currentRoom);
                box.innerHTML = "";
                filtered.forEach(c => {
                    const isMe = c.user === currentUser;
                    box.innerHTML += `
                    <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-in slide-in-from-bottom-2">
                        <span class="text-[8px] font-bold text-gray-500 mb-1 uppercase tracking-widest">${c.user}</span>
                        <div class="${isMe ? 'bg-sky-600 text-white rounded-br-none' : 'bg-white/5 text-gray-300 rounded-bl-none'} p-4 rounded-2xl text-xs max-w-[85%] border border-white/5 shadow-xl">
                            ${c.message}
                        </div>
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            } catch(e) { console.error("Error de sincronizaci√≥n de chat."); }
        }

        async function sendMsg() {
            const inp = document.getElementById('chat-inp');
            if(!inp.value) return;
            try {
                await fetch(`${API}/chats`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user: currentUser, 
                        message: inp.value, 
                        room: currentRoom, 
                        timestamp: new Date().toLocaleTimeString()
                    })
                });
                inp.value = "";
                refreshChats();
            } catch(e) { alert("Error al enviar mensaje al Gateway."); }
        }

        function syncRoomUI() {
            const sel = document.getElementById('room-select');
            const side = document.getElementById('side-room-list');
            sel.innerHTML = ""; side.innerHTML = "";
            roomsFound.forEach(r => {
                const opt = document.createElement('option'); opt.value = r; opt.innerText = `CHANNEL_${r.toUpperCase()}`;
                sel.appendChild(opt);
                const div = document.createElement('div');
                div.className = `w-12 h-12 rounded-2xl flex items-center justify-center cursor-pointer text-[10px] font-black border transition-all ${currentRoom === r ? 'bg-sky-600 border-sky-500 text-white' : 'border-white/10 text-gray-600 hover:border-white/30'}`;
                div.innerText = r.substring(0,2).toUpperCase();
                div.onclick = () => { currentRoom = r; refreshChats(); };
                side.appendChild(div);
            });
            sel.value = currentRoom;
        }

        function createNewRoom() { const r = prompt("NUEVO NODO (ID):"); if(r) { roomsFound.add(r.toLowerCase()); currentRoom = r.toLowerCase(); refreshChats(); } }

        // --- UPLOAD: ACTIVANDO MEDIA_HANDLER Y THREADS ---
        async function handleUpload(files) {
            const title = prompt("T√çTULO DEL DATA_PACK:");
            if(!title || !files) return;
            const fd = new FormData();
            fd.append('file', files[0]);
            fd.append('username', currentUser);
            fd.append('title', title);
            
            alert("SUBIENDO BINARIOS A " + DOMAIN + "... Por favor, espera.");
            
            try {
                const res = await fetch(`${API}/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                if(data.status === "processing") alert("√âXITO: El servidor ha iniciado el procesamiento del video en segundo plano.");
            } catch(e) { alert("ERROR DE UPLOAD: Verifica la conexi√≥n o el tama√±o del archivo."); }
        }
    </script>
</body>
</html>
