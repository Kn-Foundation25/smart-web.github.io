<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-Web | Cyan Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --cyan: #00f2ff; --dark-blue: #000d1a; }
        body { background: var(--dark-blue); color: #e0ffff; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Estética Neón */
        .neon-border { border: 1px solid var(--cyan); box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        .glass { background: rgba(0, 242, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(0, 242, 255, 0.1); }
        .hidden { display: none !important; }
        
        /* Personalización de Scroll */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 10px; }
        
        /* Animación de escaneo */
        .scanline { width: 100%; height: 2px; background: var(--cyan); opacity: 0.1; position: absolute; animation: scan 4s linear infinite; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center relative">
    <div class="scanline"></div>

    <!-- PANTALLA DE INTRODUCCIÓN -->
    <div id="intro-layer" class="hidden fixed inset-0 z-50 bg-black flex items-center justify-center">
        <video id="intro-vid" class="w-full h-full object-cover">
            <source src="real.mp4" type="video/mp4">
        </video>
    </div>

    <!-- PORTAL DE ACCESO -->
    <div id="auth-section" class="w-full max-w-md p-10 glass neon-border rounded-[2.5rem] text-center relative z-10">
        <h1 class="text-5xl font-black italic text-cyan-400 tracking-tighter mb-2 drop-shadow-[0_0_8px_#00f2ff]">SMART-WEB</h1>
        <p class="text-[10px] text-cyan-700 tracking-[0.5em] mb-10 uppercase">Conexión de Nodo Establecida</p>
        
        <form onsubmit="event.preventDefault();" class="space-y-5">
            <input type="text" id="user-in" name="username" autocomplete="username" placeholder="IDENTIFICADOR" 
                class="w-full bg-black/40 border border-cyan-900 p-4 rounded-xl outline-none focus:border-cyan-400 text-cyan-100 text-xs tracking-widest uppercase transition-all">
            
            <input type="password" id="pass-in" name="password" autocomplete="current-password" placeholder="CÓDIGO_ACCESO" 
                class="w-full bg-black/40 border border-cyan-900 p-4 rounded-xl outline-none focus:border-cyan-400 text-cyan-100 text-xs tracking-widest uppercase transition-all">
            
            <div class="flex gap-4 pt-4">
                <button type="button" onclick="handleAuth('login')" class="flex-1 bg-cyan-500 text-black font-black py-4 rounded-xl text-[10px] uppercase hover:bg-cyan-300 transition-all shadow-[0_0_15px_rgba(0,242,255,0.4)]">Entrar</button>
                <button type="button" onclick="handleAuth('register')" class="flex-1 border border-cyan-500 text-cyan-400 font-bold py-4 rounded-xl text-[10px] uppercase hover:bg-cyan-500/10 transition-all">Registrar</button>
            </div>
        </form>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div id="main-panel" class="hidden fixed inset-0 flex flex-col">
        <!-- Header Tecnológico -->
        <header class="h-20 border-b border-cyan-900/30 flex items-center justify-between px-10 glass">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-cyan-500 rounded-full animate-pulse"></div>
                <span class="text-xl font-black italic text-cyan-400 tracking-tighter">SMART-TUBE.INF</span>
            </div>
            
            <div class="flex items-center gap-6">
                <button onclick="document.getElementById('file-up').click()" class="bg-cyan-500 text-black px-8 py-2 rounded-full text-[10px] font-black uppercase hover:scale-105 transition-all">Subir Multimedia</button>
                <button onclick="logout()" class="text-[10px] text-cyan-900 hover:text-red-500 font-bold uppercase transition-colors">Desconectar</button>
                <div id="u-avatar" class="w-10 h-10 rounded-xl bg-cyan-500/20 border border-cyan-500 flex items-center justify-center text-cyan-400 font-black">?</div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Muro de Videos -->
            <main class="flex-1 overflow-y-auto p-12 grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-10 bg-[#000810]" id="vid-grid"></main>
            
            <!-- Chat de Nodo -->
            <aside class="w-96 border-l border-cyan-900/20 flex flex-col glass bg-black/20">
                <div class="p-6 border-b border-cyan-900/20 text-[10px] font-black text-cyan-800 tracking-widest uppercase italic">Comunicaciones_Cifradas</div>
                <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
                <div class="p-6 border-t border-cyan-900/20">
                    <input type="text" id="chat-in" onkeydown="if(event.key==='Enter') sendMsg()" placeholder="Enviar mensaje al nodo..." 
                        class="w-full bg-white/5 border border-cyan-900/40 p-4 rounded-xl outline-none text-xs text-cyan-100 focus:border-cyan-500">
                </div>
            </aside>
        </div>
    </div>

    <!-- Archivo oculto -->
    <input type="file" id="file-up" class="hidden" accept="video/mp4" onchange="uploadVid(this.files)">

    <script>
        // CONFIGURACIÓN DE NODO
        const BASE_URL = "https://smartdns.duckdns.org";
        const API = `${BASE_URL}/api`;
        const STREAM = `${BASE_URL}/stream`;
        
        let activeUser = localStorage.getItem("smart_session");

        window.onload = () => { if (activeUser) initApp(); };

        async function handleAuth(mode) {
            const u = document.getElementById('user-in').value;
            const p = document.getElementById('pass-in').value;
            if(!u || !p) return alert("DATOS_INCOMPLETOS");

            try {
                const res = await fetch(`${API}/auth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u, password: p, mode: mode})
                });

                if(res.ok) {
                    activeUser = u;
                    localStorage.setItem("smart_session", u);
                    
                    // Activar Pantalla Completa
                    if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                    
                    const layer = document.getElementById('intro-layer');
                    const vid = document.getElementById('intro-vid');
                    layer.classList.remove('hidden');
                    vid.play();

                    vid.onended = () => {
                        layer.classList.add('hidden');
                        initApp();
                    };
                    vid.onerror = () => { // Si falla el video, saltar intro
                        layer.classList.add('hidden');
                        initApp();
                    };
                } else alert("ACCESO_RECHAZADO");
            } catch(e) { alert("NODO_OFFLINE"); }
        }

        function initApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-panel').classList.remove('hidden');
            document.getElementById('u-avatar').innerText = activeUser.charAt(0).toUpperCase();
            renderVideos();
            setInterval(renderChats, 4000);
        }

        function logout() {
            localStorage.removeItem("smart_session");
            location.reload();
        }

        async function renderVideos() {
            const res = await fetch(`${API}/videos`);
            const vids = await res.json();
            document.getElementById('vid-grid').innerHTML = vids.reverse().map(v => {
                const isOwner = v.author === activeUser;
                return `
                <div class="glass rounded-[2rem] overflow-hidden group hover:border-cyan-500/50 transition-all duration-500">
                    <video src="${STREAM}/video/${v.id}/${v.author}" controls class="w-full aspect-video bg-black"></video>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h4 class="text-cyan-400 font-black uppercase text-[10px] tracking-widest">${v.title}</h4>
                            ${isOwner ? `<button onclick="deleteVid('${v.id}')" class="text-red-900 hover:text-red-500 text-[9px] font-bold">ELIMINAR</button>` : ''}
                        </div>
                        <div class="flex justify-between items-center text-[9px] text-cyan-900 font-bold">
                            <span>SINC_POR: ${v.author}</span>
                            <button onclick="hitLike('${v.id}')" class="bg-cyan-500/10 px-4 py-2 rounded-lg text-cyan-500 hover:bg-cyan-500 hover:text-black transition-all">
                                ▲ <span id="l-${v.id}">${v.likes}</span>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function deleteVid(id) {
            if(!confirm("¿CONFIRMAR DESTRUCCIÓN DE DATOS?")) return;
            const res = await fetch(`${API}/video/delete/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: activeUser })
            });
            if(res.ok) renderVideos();
        }

        async function uploadVid(files) {
            if(!files.length) return;
            const t = prompt("ETIQUETA_DATOS:");
            const d = new FormData();
            d.append('file', files[0]);
            d.append('username', activeUser);
            d.append('title', t || "SIN_NOMBRE");

            fetch(`${API}/upload`, { method: 'POST', body: d });
            alert("TRANSFERENCIA_INICIADA");
            setTimeout(renderVideos, 5000);
        }

        async function hitLike(id) {
            const res = await fetch(`${API}/social/interact/${id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: activeUser })
            });
            const data = await res.json();
            document.getElementById(`l-${id}`).innerText = data.count;
        }

        async function sendMsg() {
            const i = document.getElementById('chat-in');
            if(!i.value) return;
            await fetch(`${API}/chats`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user: activeUser, text: i.value, time: new Date().toLocaleTimeString()})
            });
            i.value = ""; renderChats();
        }

        async function renderChats() {
            const res = await fetch(`${API}/chats`);
            const data = await res.json();
            document.getElementById('chat-box').innerHTML = data.slice(-12).map(c => `
                <div class="bg-cyan-500/5 p-4 rounded-2xl border-l-2 border-cyan-500/30">
                    <p class="text-[9px] text-cyan-600 font-black uppercase mb-1">${c.user} <span class="opacity-50"># ${c.time}</span></p>
                    <p class="text-xs text-cyan-100/80">${c.text}</p>
                </div>
            `).reverse().join('');
        }
    </script>
</body>
</html>
